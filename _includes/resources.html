<style>

.page-wrapper {
  margin: 0 auto;
  position: relative;
  z-index: 1;
}

#resources {
  color: #000;
  background-color: #f5f5f5;
  padding: 80px 20px;
  position: relative;
  margin-left: 240px;
  z-index: 2;
}
#resources-sidebar {
  position: absolute;
  width: 240px;
  display: block;
  background: #000;
  top: 0;
  bottom: 0;
  left: 0;
  z-index: 3;
}
.menu-btn {
  cursor: pointer;
  position: fixed;
  top: 55px;
  left: 5px;
  font-size: 16px;
  display: none;
}
.navbar-toggle.collapsed {
  margin-bottom: 0px;
}

@media screen and (max-width: 980px){
  .menu-btn {
    display: block;
  }
  .menu-btn.is-open {
    left: 245px;
  }
  #resources-sidebar {
    margin-left: -240px;
  }
  #resources-sidebar.is-open {
    margin-left: 0px;
  }
  #resources {
    margin-left: 0;
  }
  #resources.is-open {
    margin-left: 240px;
    margin-right: -240px;
  }
}

#resources-sidebar, #resources, .menu-btn {
  -webkit-transition: all 0.6s ease 0s;
  -moz-transition: all 0.6s ease 0s;
  -ms-transition: all 0.6s ease 0s;
  -o-transition: all 0.6s ease 0s;
  transition: all 0.6s ease 0s;
}

.nav-wrapper {
  width: 240px;
  position: fixed;
  top: 50px;
  bottom: 0;
  margin: 0;
  overflow: auto;
  padding-left: 2px;
  padding-bottom: 60px;

}
/* all links */
.nav-wrapper .nav>li>a {
    color: #999;
    padding: 4px 20px;
    font-size: 13px;
    font-weight: 400;
    border-left: 2px solid transparent;
}

/* all active links */
.nav-wrapper .nav>.active>a,
.nav-wrapper .nav>li>a:hover,
.nav-wrapper .nav>li>a:focus {
  color: #fff;
  text-decoration: none;
  background-color: transparent;
  border-left: 2px solid #fff;
}

/* nested links */
.nav-wrapper .nav .nav>li>a {
    padding-top: 1px;
    padding-bottom: 1px;
    padding-left: 30px;
    font-size: 12px;
}
/* nested nested links */
.nav-wrapper .nav .nav .nav>li>a {
    padding-top: 1px;
    padding-bottom: 1px;
    padding-left: 50px;
    font-size: 10px;
}
/* hide all (inactive) nested list */
.nav-wrapper .nav ul.nav {
    display: none;
}
/* show active nested list */
.nav-wrapper .nav>.active>ul.nav {
    display: block;
}

.resources-block, .resources-item {
  padding-top: 70px;
  margin-top: -70px;
}
.resources-item {
  margin-bottom: 3px;
  margin-left: 12px;
}


.folder-name.level-0 {
  margin: 32px 0 16px 0;
  text-transform: uppercase;
  font-family: Montserrat,"Helvetica Neue",Helvetica,Arial,sans-serif;
  font-size: 24px;
  font-weight: 900;
  letter-spacing: 1px;
}
.folder-name.level-1 {
  margin: 14px 0 16px 0;
  text-transform: uppercase;
  font-family: Montserrat,"Helvetica Neue",Helvetica,Arial,sans-serif;
  font-size: 14px;
  font-weight: 600;
  letter-spacing: 1px;
}
.folder-name.level-2 {
  margin: 12px 0 6px 0;
  font-family: Montserrat,"Helvetica Neue",Helvetica,Arial,sans-serif;
  font-size: 12px;
  font-weight: 400;
  letter-spacing: 1px;
}

.resources-item a {
    color: #4C4C4C;
    -webkit-transition: all .2s ease-in-out;
    -moz-transition: all .2s ease-in-out;
    transition: all .2s ease-in-out;
}
.resources-item a:hover,
.resources-item a:focus {
    text-decoration: none;
    color: #ed1b2e;
    cursor: pointer;
}


#search-box .tt-menu{
  max-height: 250px;
  overflow-y: scroll;
  overflow-y: -moz-scrollbars-vertical;
}
.typeahead,
.tt-query,
.tt-hint {
  width: 396px;
  height: 30px;
  padding: 8px 12px;
  font-size: 14px;
  line-height: 30px;
  border: 2px solid #ccc;
  -webkit-border-radius: 8px;
     -moz-border-radius: 8px;
          border-radius: 8px;
  outline: none;
}
.typeahead {
  background-color: #fff;
}
.tt-menu .empty-message {
  padding: 5px 10px;
  text-align: center;

}
.typeahead:focus {
  border: 2px solid #0097cf;
}
.tt-query {
  -webkit-box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.075);
     -moz-box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.075);
          box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.075);
}
.tt-hint {
  color: #999
}
.tt-menu {
  z-index: 20;
  text-align: left;
  width: 422px;
  margin-top: 12px;
  padding: 8px 0;
  background-color: #fff;
  border: 1px solid #ccc;
  border: 1px solid rgba(0, 0, 0, 0.2);
  -webkit-border-radius: 8px;
     -moz-border-radius: 8px;
          border-radius: 8px;
  -webkit-box-shadow: 0 5px 10px rgba(0,0,0,.2);
     -moz-box-shadow: 0 5px 10px rgba(0,0,0,.2);
          box-shadow: 0 5px 10px rgba(0,0,0,.2);
}
.tt-suggestion {
  padding: 3px 20px;
  font-size: 12px;
  line-height: 16px;
}
.tt-suggestion:hover  {
  cursor: pointer;
  color: #fff;
  background-color: #0097cf;
}
.tt-suggestion.tt-cursor {
  color: #fff;
  background-color: #0097cf;
}
.tt-highlight {
  background-color: rgba(236,183,49,.6);
}
.tt-suggestion:hover .tt-highlight  {
  font-weight: inherit;
  background-color: inherit;
}
 p.tt-suggestion {
  margin: 0;
}


</style>

<div class="page-wrapper">
  <!--Nav Bar -->
  <nav id="resources-sidebar" class="">

    <div class="nav-wrapper">

      <ul class="nav nav-stacked nav-custom" style="padding-top:20px;" data-resourcespath="resources" >
        <li><a href="#resources" class="page-scroll">{{site.data[locale].resources.about}}</a></li>
          <!-- . . . resources nav menu goes here . . . -->
      </ul>
    </div>
  </nav>

    <!-- Resources content -->
    <div id="resources" class="">
      <div class="menu-btn"><i class="fa fa-bars"></i></div>
      <div class="text-center">
          <h2>{{site.data[locale].resources.title}}</h2>

          <div id="error-resources" style="display:none;"><p>{{site.data[locale].resources.loaderror}}</p></div>
          <div id="grouped-resources">
          <div class="row">
            <div class="col-sm-6 col-md-4 col-md-offset-2">
                <img class="img-resources img-circle" src="/img/keydocuments.jpg" alt="{{site.data[locale].resources.rcrcmovement}} {{site.data[locale].resources.keydocs}}">
                <div class="caption">
                  <p><a href="#" class="btn btn-lg btn-default btn-resources btn-movementkeydocs page-scroll" role="button">{{site.data[locale].resources.rcrcmovement}} <br><small>{{site.data[locale].resources.keydocs}}</small></a></p>
                </div>
            </div>
            <div class="col-sm-6 col-md-4">
                <img class="img-resources img-circle" src="/img/references.jpg" alt="{{site.data[locale].resources.references}} {{site.data[locale].resources.ctpguidance}}">
                <div class="caption">
                  <p><a href="#" class="btn btn-lg btn-default btn-resources btn-ctpguidance page-scroll" role="button">{{site.data[locale].resources.references}} <br><small>{{site.data[locale].resources.ctpguidance}}</small></a></p>
                </div>
            </div>
          </div>

        <p>
          <div id="search-box">
          <input class="typeahead" type="text" placeholder="{{site.data[locale].resources.searchmessage}}">
          </div>
          <div><small>({{site.data[locale].resources.suggestlimit}})</small></div>
        </p>
        </div>

      </div>

      <div id="resources-contents">
        <div data-resourcespath="resources" class="resources-block">
            <div class="contents"></div>
            <!-- . . . folders and file links go here . . . -->
        </div>
      </div>

    </div>
    <div style="width:100%; height: 500px; background-color:#f5f5f5;"></div>

</div>
<script src="/js/typeahead.bundle.js" charset="utf-8"></script>
<script src="/js/handlebars-v4.0.5.js" charset="utf-8"></script>
<script src="//d3js.org/d3.v3.min.js" charset="utf-8"></script>
<script>

// HELPERS
// #######

$('.menu-btn').on('click', function(){
  if ($('.menu-btn').hasClass('is-open')) {
    $('.menu-btn').removeClass('is-open');
    d3.select('.menu-btn').select('.fa').classed({ "fa-bars": true, "fa-times": false })
    $('#resources').removeClass('is-open');
    $('#resources-sidebar').removeClass('is-open');
  } else {
    $('.menu-btn').addClass('is-open');
    d3.select('.menu-btn').select('.fa').classed({ "fa-bars": false, "fa-times": true })
    $('#resources').addClass('is-open');
    $('#resources-sidebar').addClass('is-open');
  }
});


$('body').scrollspy({
    target: '.nav-wrapper',
    offset: 200 // // can use this or something like ...  padding-top: 70px; && margin-top: -70px;
});


var systemFile = function(filename){
  if (filename.indexOf('.') === 0){
    return true;
  } else { return false; }
};
var typeIcon = function(extension){
  switch(extension) {
    case ".doc":
    case ".docx":
      return '<i class="fa fa-fw fa-file-word-o"></i> '
      break;
    case ".jpeg":
    case ".jpg":
    case ".png":
      return '<i class="fa fa-fw fa-file-image-o"></i> '
      break;
    case ".pdf":
      return '<i class="fa fa-fw fa-file-pdf-o"></i> '
      break;
    case ".ppt":
    case ".pptx":
      return '<i class="fa fa-fw fa-file-powerpoint-o"></i> '
      break;
    case ".xls":
    case ".xlsm":
    case ".xlsx":
      return '<i class="fa fa-fw fa-file-excel-o"></i> '
      break;
    case ".zip":
      return '<i class="fa fa-fw fa-file-archive-o"></i> '
      break;
    default:
      return '<i class="fa fa-fw fa-file-o"></i> '
  }
};

function identity(ugly) {
  var ugly = 'o_' + ugly;
  var step1 = ugly.replace(/^[^-_a-zA-Z]+/, '').replace(/^-(?:[-0-9]+)/, '-');
  var step2 = step1 && step1.replace(/[^-_a-zA-Z0-9]+/g, '-');
  return step2.toLowerCase();
}



// GLOBAL VARIABLES
// ################
var language = "{{locale}}"
var emptymessage = "{{site.data[locale].resources.emptymessage}}"
var resourcesdata, modalitiesdata;

function fetchResources(){
  $.ajax({
    type: 'GET',
    url: 'http://webviz.redcross.org/ctp/resources/' + language,
    dataType: 'JSON',
    error: function(){
      $("#error-resources").show();
      $("#grouped-resources").hide();
    },
    success: function(response){
      resourcesdata = (response === undefined) ? [] : response;
      if(resourcesdata.length > 0){
        buildResources();
      } else {
        $("#error-resources").show();
        $("#grouped-resources").hide();
      }
    }
  });
}

function buildResources() {


  var folderPaths = [];
  var pathPartsArray = [];
  $.each(resourcesdata, function(index, d){
    // this is necessary to get those folders if there is a folder without a file inside (just other folders)
    for(i=2;i<=d.dboxpathparts.length;i++){
      if($.inArray(d.dboxpathparts.slice(0,i).join('/'), folderPaths) === -1) {
        folderPaths.push(d.dboxpathparts.slice(0,i).join('/'))
        pathPartsArray.push(d.dboxpathparts.slice(0,i))
      }
    }
  });

  var rollup = d3.nest()
    .key(function(d){ return d.length; })
    .sortKeys(d3.ascending)
    .sortValues(function(a,b){ return d3.ascending(a.join('/'), b.join('/')); })
    .entries(pathPartsArray);

  for(var i=0; i<rollup.length; i++){
    $.each(rollup[i].values, function(index,d){
      // find parent nav list item and add a sub element to it
      var navHtml = '<li><a href="#' + identity(d.slice(1).join('/')) + '" class="page-scroll">' + d.slice(-1) + '</a>' +
          '<ul class="nav nav-stacked" data-resourcespath="' + d.join('/') + '"></ul></li>';
      $('#resources-sidebar [data-resourcespath="' + d.slice(0,-1).join('/') + '"]').append(navHtml);
      // find parent folder list element and add a sub folder div element to it
      var contentsHtml = '<div id="' + identity(d.slice(1).join('/')) + '" class="resources-block" data-resourcespath="' + d.join('/') + '">' +
        '<div class="folder-name level-' + i + '">' +
        ' &nbsp;' + d.slice(-1) + '</div><div class="contents"></div></div>';
      $('#resources-contents [data-resourcespath="' + d.slice(0,-1).join('/') + '"]').append(contentsHtml);

      // add correct links for pretty top level folder buttons (the element id will vary for different languages)
      if(d.length === 2) {
        var pageLink = '#' + identity(d.slice(1).join('/'));
        if(pageLink.indexOf('1') > -1){
          $('.btn-resources.btn-movementkeydocs').attr('href', pageLink);
        }
        if(pageLink.indexOf('2') > -1){
          $('.btn-resources.btn-ctpguidance').attr('href', pageLink);
        }

      }
    });
  }

  resourcesdata.sort(function(a,b){ return d3.descending(a.fullpath, b.fullpath); })
    for(var i=0; i<resourcesdata.length; i++){
      if(systemFile(resourcesdata[i].basename) === false){
        if(resourcesdata[i].dboxpathparts.length === 1){
          var thisHtml = '<div id="' + identity(resourcesdata[i].dboxpathparts.slice(1).join('/') + resourcesdata[i].basename) + '">' +
            '<a target="_blank" href="http://webviz.redcross.org/ctp/docs/' + language + '/resources/' + resourcesdata[i].basename + '">' +
            resourcesdata[i].basename.slice(0,resourcesdata[i].basename.indexOf(resourcesdata[i].ext)) + ' ' + typeIcon(resourcesdata[i].ext) + '</a></div>';
          $('.overview-docs').append(thisHtml);
        } else {
          var thisHtml = '<div class="resources-item" id="' + identity(resourcesdata[i].dboxpathparts.slice(1).join('/') + resourcesdata[i].basename) + '">' +
            '<a target="_blank" href="http://webviz.redcross.org/ctp/docs/' + language + '/' +
            resourcesdata[i].dboxpathparts.join('/') + '/' + resourcesdata[i].basename + '">' +
            resourcesdata[i].basename.slice(0,resourcesdata[i].basename.indexOf(resourcesdata[i].ext)) + ' ' + typeIcon(resourcesdata[i].ext) + '</a></div>';
            // console.log(identity(resourcesdata[i].dboxpathparts.join('/')))
          $('[data-resourcespath="' + resourcesdata[i].dboxpathparts.join('/') + '"]').children('.contents').prepend(thisHtml);
        }
      }
    }

    $(function() {
        $('a.page-scroll').bind('click', function(event) {
            var $anchor = $(this);
            $('html, body').stop().animate({
                scrollTop: $($anchor.attr('href')).offset().top
            }, 1500, 'easeInOutExpo');
            event.preventDefault();
        });
    });


  buildSearchBox();

}


// this section uses handlebars
// need to escape it so jekyll doesn't mess it up
{% raw %}

function buildSearchBox(){
  // format the data for inclusion into the search
  var searchData = []
  $.each(resourcesdata, function(index, d){
    // exclude system files and files not in a folder (they go higher up the page)
    if(systemFile(d.basename) === false && d.dboxpathparts.length>1){
      searchData.push({
        "name": d.basename.slice(0,d.basename.indexOf(d.ext)),
        "type": d.ext.slice(1),
        "path": d.dboxpathparts.slice(1).join(' / '),
        "href": '#' + identity(d.dboxpathparts.slice(1).join('/') + d.basename)
      })
    }
  })

  // constructs the suggestion engine
  var documents = new Bloodhound({
    datumTokenizer: Bloodhound.tokenizers.obj.whitespace('name' , 'type', 'path'),
    queryTokenizer: Bloodhound.tokenizers.whitespace,
    local: searchData,
    sorter: function(a, b) {
      if (a.path < b.path) {
        return -1;
      }
      else if (a.path > b.path) {
        return 1;
      }
      else return 0;

    }
  });

  // kicks off the loading/processing of `local`
  documents.initialize();

  $('#search-box .typeahead').typeahead({
    // hint: true,
    highlight: true,
    minLength: 1
  },
  {
    name: 'documents',
    displayKey: Handlebars.compile('{{name}}'),
    limit: 20,
    source: documents.ttAdapter(),
    templates: {
      empty:[
        '<div class="empty-message">',
        '<i>' + emptymessage + '</i>',
        '</div>'
      ].join('\n'),
      suggestion: Handlebars.compile('<p>{{path}} <br> &nbsp;&nbsp;&nbsp;{{name}}</p>')
    }
  }).on('typeahead:selected', function (eventObj, datum) {
    selectedDocument(datum);
  });
}
{% endraw %}

function selectedDocument(datum) {

  $('html, body').stop().animate({
      scrollTop: $(datum.href).offset().top
  }, 1500, 'easeInOutExpo');

  $('#search-box .typeahead').typeahead('val', '');

}

fetchResources();

</script>
